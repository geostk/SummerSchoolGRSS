#+TITLE: Spectral Unmixing
#+SUBTITLE: GRSS Summer School
#+AUTHOR: Mathieu Fauvel
#+EMAIL: mathieu.fauvel@ensat.fr
#+DATE: [2017-04-26 Wed]--[2017-04-27 Thu]

#+INCLUDE_TAGS: export
#+EXCLUDE_TAGS: noexport
#+LANGUAGE: en
#+OPTIONS: H:3 toc:t tags:nil properties:nil

#+COLUMNS: %40ITEM(Task) %17Effort(Estimated Effort){:} %CLOCKSUM

#+LaTeX_CLASS_OPTIONS: [10pt,aspectratio=1610]

#+BEAMER_THEME: DarkConsole
#+BEAMER_HEADER: \institute{UMR Dynafor}
#+BEAMER_HEADER: \AtBeginSection[]{\begin{frame}<beamer>\frametitle{Outline}\tableofcontents[currentsection]\end{frame}}
#+BEAMER_HEADER: \AtBeginSubsection[]{\begin{frame}<beamer>\frametitle{Outline}\tableofcontents[currentsubsection]\end{frame}}
#+BEAMER_HEADER: \setbeamercovered{again covered={\opaqueness<1->{25}}}
#+BEAMER_HEADER: \usefonttheme[onlymath]{serif}

#+LATEX_HEADER: \usepackage[english]{babel}\usepackage{etex}\usepackage{minted}\usemintedstyle{emacs}
#+LATEX_HEADER: \usepackage{tikz}\usepackage{amsmath}\usepackage[T1]{fontenc}\usepackage{lmodern}%\usepackage{arev}
#+LATEX_HEADER: \usepackage{booktabs}\usepackage[citestyle=alphabetic,bibstyle=authortitle]{biblatex}
#+LATEX_HEADER: \usepackage{pgfplots,pgfplotstable}\usetikzlibrary{pgfplots.groupplots}\usepackage[babel=true,kerning=true]{microtype}\usepackage{smartdiagram}
#+LATEX_HEADER: \addbibresource{unmix.bib}
#+LATEX_HEADER: \usetikzlibrary{mindmap,trees,shapes,arrows,spy,3d,decorations.pathmorphing,pgfplots.statistics,pgfplots.dateplot}
#+LATEX_HEADER: \pgfplotsset{compat=newest}

#+LATEX_HEADER: \hypersetup{colorlinks,linkcolor=,urlcolor=magenta}

* Motivations                                                        :export:
*** Spectral mixing
- /When a pixel contains several materials: all these materials contribute to the collected reflectance/\nbsp{}cite:manolakis2016hyperspectral
- It is called a /mixel/ or /mixed spectra/ and pure contributions are termed /endmembers/
**** original
:PROPERTIES:
:BEAMER_col: 0.3
:END:
#+ATTR_LATEX: :width 4cm :options [trim=1cm 2cm 2cm 1cm,clip=true]
[[file:./figures/46_8.jpg]]
**** Text :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.7
:END:
#+ATTR_LATEX: :width \textwidth 
[[file:./figures/mixing_process.png]]

*** Example

#+BEGIN_EXPORT latex
\begin{center}
\begin{tikzpicture}
\begin{axis}[xmin=0.4,xmax=2.5,ymin=0,ymax=1,grid,xlabel=$\lambda~({\mu}m)$,ylabel=Reflectance,width=\linewidth,height=0.9\textheight]
  \pgfplotstableread{figures/grass.txt}\loadedtable
  \addplot+[mark=none,smooth,thick,red] table[x=wave,y=grass] from \loadedtable;
  \addplot+[mark=none,smooth,thick,red!75!blue,dashed] table[x=wave,y expr=0.75*\thisrow{grass}+0.25*\thisrow{drygrass}] from \loadedtable;
  \addplot+[mark=none,smooth,thick,red!50!blue,dashed] table[x=wave,y expr=0.5*\thisrow{grass}+0.5*\thisrow{drygrass}] from \loadedtable;
  \addplot+[mark=none,smooth,thick,red!25!blue,dashed] table[x=wave,y expr=0.25*\thisrow{grass}+0.75*\thisrow{drygrass}] from \loadedtable;
  \addplot+[mark=none,smooth,thick,blue] table[x=wave,y=drygrass] from \loadedtable;
  \legend{Grass,0.75*Grass+0.25*Dry-Grass,0.5*Grass+0.5*Dry-Grass,0.25*Grass+0.75*Dry-Grass, Dry-Grass}
\end{axis}
\end{tikzpicture}
\end{center}
#+END_EXPORT

*** Applications
- Conventional mapping applications cite:Bioucas_IEEE_JSTARS_2012:
  + Mineral proportions
  + Vegetation covers
- Multisource fusion:
  + Sources of various spatial resolution
  + Sources of various spectral resolution
- Misc:
  + Post-improvement of classification maps
  + Clouds reconstruction of multi-temporal HI

*** Unmixing processing chain
1. Athmospheric correction
2. Dimensionality reduction
3. Find endmembers
   - Hyperspectral library
   - Unsupervised
4. Find abundances
* Spectral mixture models                                            :export:
** Linear models
*** Linear mixture model
- Each pixel is a convex linear combination of endmenbers (pure spectra):
  $$ \mathbf{x} = \sum_{j=1}^p\alpha_{j}\mathbf{m}_j + \mathbf{e}$$
  + $\mathbf{m}_j$ is the $j^\text{th}$ endmember,
  + $\alpha_{j}$ is the abundance of endmember $j$,
  + $\mathbf{e}$ is the modelling error.
- The abundances are subject to the following constraints:
  + Non negativity: $\alpha_j\geq 0, \forall j=1,\ldots,p$
  + Sum to one: $\sum_{j=1}^p\alpha_{j}=1$.
- Matricial formulation:
  $$ \mathbf{x} = \mathbf{M}\boldsymbol{\alpha} +\mathbf{e} $$
  where $\mathbf{M}=\big[\mathbf{m}_1,\ldots,\mathbf{m}_p\big]$.
*** Geometric viewpoint
- If endmembers are affinely independent, hyperspectral pixels live in
  the convex hull $C$ generated by the endmembers
- $C:=\Big\{\mathbf{x}=\mathbf{M}\boldsymbol{\alpha}|\sum_{j=1}^p\alpha_{j}=1,\ \alpha_j\geq 0, \forall j=1,\ldots,p \Big\}$

  #+BEGIN_EXPORT latex
  \begin{center}
    \begin{tikzpicture}[scale=1.5]
      \draw[->] (0,0) -- (3,0);
      \draw[->] (0,0) -- (0,3);
      \fill[gray!50] (0.5,0) -- (0.25,2.5) -- (2.5,1.5) -- (0.5,0);
      \draw (1,1) node[black,above right]  {$C$};
      \fill[red] (0.5,0) circle (1pt) node[below] {$\mathbf{m}_1$};
      \fill[red] (0.25,2.5) circle (1pt) node[above] {$\mathbf{m}_2$};
      \fill[red] (2.5,1.5) circle (1pt)  node[right] {$\mathbf{m}_3$};
    \end{tikzpicture}
  \end{center}

  #+END_EXPORT
** Non linear model
*** Bilinear models
- Consider multiple reflections cite:6816071
  #+ATTR_LATEX: :width 0.5\textwidth
  [[file:./figures/fig_bilinear.png]]
- The model
  $$\mathbf{x} = \sum_{j=1}^p\alpha_j\mathbf{m}_j + \sum_{j,k=1}^{p}\beta_{j,k}\mathbf{m}_j\odot\mathbf{m}_j$$
- Several possible constraints on $\alpha$ and $\beta$
*** Other models
- Physics based model: Intimate mixture (e.g., Hapke model)
- Computer graphics: ray tracing
- Kernel methods:
  + "kernelized" linear models
  + Construct "smart" kernels
* Subspace and Endmember extraction                                  :export:
** Subspace extraction
*** Conventional methods
Find the subspace signal in order to search the endmembers:
- Principal component analysis: /find the subspace that minimizes reconstruction error/
- Minimum noise fraction: /find the subspace that maximizes the SNR/
- HySime (hyperspectral subspace identification)
  + /Estimation of the signal and noise subspaces/
  + /Find the subpace that best represents the signal subspace/
** Endmember extraction
*** Pixel Purity Index cite:Boardman1995
1. Apply MNF
2. Project pixels onto random vector and find /extreme/ projected pixels and store them
3. Pixels with the highest score are identified as the /purest one/

#+ATTR_LATEX: :width 0.6\textwidth
[[file:./figures/ppi.png]]
*** N-FINDR cite:findr
- Assumes pure pixels are present
- Find the pixels that maximizes the volume of the simplex

#+ATTR_LATEX: :width 0.6\textwidth
[[file:./figures/nfindr.png]]
*** Vertex component analysis cite:1411995

- Iteratively project  pixels on /orthogonal direction/  to the subspace
  spanned by previously selected endmembers
- New endmember correpond to the extreme of the projection
- Works similarly to /orthogonal subspace projection/ but accounting for the noise

** Endmember extraction in action
*** Moffett data
#+ATTR_LATEX: :width 0.7\textwidth 
[[file:./figures/moffett.png]]
*** Endmember extraction
#+BEGIN_SRC python :tangle ../Codes/endmember_extraction.py :exports none
import rasterTools as rt
import scipy as sp
import pysptools.eea as eea

# Load data set
im,GeoT,Proj = rt.open_data('../Data/Moffett_full.tif')
[h,w,b]=im.shape
wave = sp.loadtxt('../Data/wave_moffett.csv',delimiter=',')

# NFINDR
nfindr = eea.NFINDR()
Unf = nfindr.extract(im.astype(float), 3, normalize=True)

# Plot endmember
T =  sp.concatenate((wave[:,sp.newaxis],Unf.T),axis=1)
sp.savetxt("../Unmixing/figures/endmembers.csv",T,delimiter=",")
#+END_SRC

#+BEGIN_EXPORT latex
\begin{center}
\begin{tikzpicture}
\begin{axis}[xmin=450,xmax=2500,ymin=0,ymax=1,grid,xlabel=$\lambda~({\mu}m)$,ylabel=Reflectance,width=\linewidth,height=0.9\textheight]
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=1,col sep = comma, restrict x to domain=410:1802,forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=1,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};

  \addplot+[mark=none,smooth,thick] table[x index=0,y index=2,col sep = comma, restrict x to domain=410:1802,forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=2,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};

  \addplot+[mark=none,smooth,thick] table[x index=0,y index=3,col sep = comma, restrict x to domain=410:1802, forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=3,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};
  \end{axis}
\end{tikzpicture}
\end{center}
#+END_EXPORT
* Linear unmixing                                                    :export:
** Abundance estimation
*** Unconstrained least squares
- One the  endmembers are  estimated, abundances  can be  estimated by
  minimizing a reconstruction error $Re$:
  $$\hat{\boldsymbol{\alpha}}=\min_{\boldsymbol{\alpha}} \Big\{Re(\mathbf{x},\mathbf{M}\boldsymbol{\alpha})\Big\}$$

- Conventionally $Re$ is chosen as the mean square square error:
  $$\hat{\boldsymbol{\alpha}}=\min_{\boldsymbol{\alpha}} \|\mathbf{x}-\mathbf{M}\boldsymbol{\alpha}\|^2$$

- Without any constraint the solution is given by 
  $$\hat{\boldsymbol{\alpha}} = \big(\mathbf{M}^\top\mathbf{M}\big)^{-1}\mathbf{M}^\top\mathbf{x}$$
*** Constrainted least squares
- Positive constraints:
  #+BEGIN_EXPORT latex
  \begin{eqnarray*}
    \hat{\boldsymbol{\alpha}}=\min_{\boldsymbol{\alpha}} \|\mathbf{x}-\mathbf{M}\boldsymbol{\alpha}\|^2 \\
    \text{Subject to } \alpha_j\geq 0, \forall j=1,\ldots,p
  \end{eqnarray*}
  #+END_EXPORT

- Full set of constraints 
  #+BEGIN_EXPORT latex
  \begin{eqnarray*}
    \hat{\boldsymbol{\alpha}}=\min_{\boldsymbol{\alpha}} \|\mathbf{x}-\mathbf{M}\boldsymbol{\alpha}\|^2 \\
    \text{Subject to } \sum_{j=1}^p\alpha_{j}=1, \alpha_j\geq 0, \forall j=1,\ldots,p
  \end{eqnarray*}
  #+END_EXPORT
- Not explicit solution ! Needs to optimize a quadratic function under convex constraints.
- This is known as /non negative least squares unmixing/ or  /fully constraints least square unmixing/
- Easy trick: use only positive constraints that add manually the /sum to one constraint/ !
*** NNLS
#+BEGIN_SRC python :results output :exports both
from scipy import optimize
import scipy as sp

# Load endmembers
M = sp.loadtxt("../Unmixing/figures/endmembers.csv",delimiter=',')[:,1:]
x = 0.2*M[:,0] + 0.7*M[:,1] + 0.1*M[:,2] 

# NNLS
res = optimize.nnls(M,x)
print res[0]
#+END_SRC

#+RESULTS:
: [ 0.2  0.7  0.1]

*** FCLS 1/2
#+BEGIN_SRC python :results output :exports both
from scipy import optimize
import scipy as sp

# Loss 
def loss(alpha,x,M):
    e = x-sp.dot(M,alpha)
    return (e**2).sum()

def jac(alpha,x,M):
    e = x-sp.dot(M,alpha)
    return -2*sp.dot(M.T,e)

cons = {'type':'eq','fun':lambda alpha: 1-alpha.sum(),'jac':lambda alpha: -alpha}
bnds = ((0, None), (0, None), (0, None,))

# Load endmembers
M = sp.loadtxt("../Unmixing/figures/endmembers.csv",delimiter=',')[:,1:]
x = 0.2*M[:,0] + 0.7*M[:,1] + 0.1*M[:,2] 

# Optimize
alpha0 = sp.ones((3,))/3.0
res = optimize.minimize(loss, alpha0, args=(x,M,), jac=jac,constraints=cons, method='SLSQP',
                        bounds=bnds,)
print res['x']
#+END_SRC 
#+RESULTS:
: [ 0.16441937  0.67116125  0.16441937]
*** FCLS 2/2
#+BEGIN_EXPORT latex
\begin{center}
\begin{tikzpicture}
\begin{axis}[xmin=450,xmax=2500,ymin=0,ymax=1,grid,xlabel=$\lambda~({\mu}m)$,ylabel=Reflectance,width=\linewidth,height=0.9\textheight]
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=1,col sep = comma, restrict x to domain=410:1802,forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=1,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};

  \addplot+[mark=none,smooth,thick] table[x index=0,y index=2,col sep = comma, restrict x to domain=410:1802,forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=2,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};

  \addplot+[mark=none,smooth,thick] table[x index=0,y index=3,col sep = comma, restrict x to domain=410:1802, forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,thick] table[x index=0,y index=3,col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};

  \addplot+[mark=none,smooth,very thick,orange,] table[x index=0,y expr=0.2*\thisrowno{1} +0.7*\thisrowno{2} + 0.1*\thisrowno{3},col sep = comma, restrict x to domain=410:1802, forget plot] {figures/endmembers.csv};
  \addplot+[mark=none,smooth,very thick,orange,] table[x index=0,y expr=0.2*\thisrowno{1} +0.7*\thisrowno{2} + 0.1*\thisrowno{3},col sep = comma, restrict x to domain=1952:2500] {figures/endmembers.csv};
  \end{axis}
\end{tikzpicture}
\end{center}
#+END_EXPORT
*** Abundance maps 1/4
#+BEGIN_SRC python :exports code :tangle ../Codes/script_unmixing.py
from scipy import optimize
import scipy as sp
import rasterTools as rt
import pysptools.eea as eea

# Number of endmembers
NE = 3

# Load images
im,GeoT,Proj = rt.open_data('../Data/Moffett_full.tif')
[h,w,b]=im.shape
wave = sp.loadtxt('../Data/wave_moffett.csv',delimiter=',')

# Compute endmenbers
nfindr = eea.NFINDR()
M = nfindr.extract(im.astype(float), NE, normalize=False).T

abundances = sp.empty((h,w,NE))
for h_ in xrange(h):
    for w_ in xrange(w):
        x = im[h_,w_,:]
        res = optimize.nnls(M,x)
        a = res[0]
        abundances[h_,w_,:]= (a/a.sum())

# Write the image
rt.write_data("../Data/Moffett_abundances.tif",abundances,GeoT,Proj)
#+END_SRC
*** Abundances 2/4
#+ATTR_LATEX: :width 0.7\textwidth 
[[file:./figures/abundances_baresoil.png]]

*** Abundances 3/4
#+ATTR_LATEX: :width 0.7\textwidth 
[[file:./figures/abundances_water.png]]
*** Abundances 4/4
#+ATTR_LATEX: :width 0.7\textwidth 
[[file:./figures/abundances_vegetation.png]]
** Advanced abundance estimation
*** Sparse unmixing
- When the number of endmembers are large (e.g. selected from spectral
  library), the observed  spectral vector is usually  a combination of
  few ones.
- Add /sparsity/ constraints in the optimization problem such as
#+BEGIN_EXPORT latex
\begin{center}
  \begin{eqnarray*}
    \min_{\boldsymbol{\alpha}} \|\boldsymbol{\alpha}\|_{0} \\
    \text{Subject to } \|\mathbf{x}-\mathbf{M}\boldsymbol{\alpha}\|^2 \leq \delta, \alpha_j\geq 0, \forall j=1,\ldots,p
  \end{eqnarray*}
\end{center}
#+END_EXPORT
- However, this problem is NP-hard: no straightforward solution
- Use convex formulation from /sparse regression/ (LASSO):
  #+BEGIN_EXPORT latex
  \begin{center}
  \begin{eqnarray*}
  \min_{\boldsymbol{\alpha}} \|\mathbf{x}-\mathbf{M}\boldsymbol{\alpha}\|^2  + \lambda \|\boldsymbol{\alpha}\|_{1}\\
  \text{Subject to }\alpha_j\geq 0, \forall j=1,\ldots,p
  \end{eqnarray*}
  \end{center}
  #+END_EXPORT
*** Spatial/Contextual unmixing
- Add spatial constraints during the optimization
- Total variation cite:DBLP:journals/tgrs/IordacheBP12: measure the spatial variation of abundances for neighboring pixels
  $$ TV(\boldsymbol{\alpha}_i) = \sum_{j\in \mathcal{N}_i} \|\boldsymbol{\alpha}_i-\boldsymbol{\alpha}_j\|_{1}$$
- Global optimization rather than pixel wise optimization:
  #+BEGIN_EXPORT latex
\begin{center}
  \begin{eqnarray*}
     \sum_{i=1}^n   \|\mathbf{x}_i-\mathbf{M}\boldsymbol{\alpha}_i\|^2 + \lambda \sum_{i=1}^n\|\boldsymbol{\alpha}_i\|_{1} + \lambda_{TV}\sum_{i=1}^nTV(\boldsymbol{\alpha}_i)\\
     \text{Subject to }\alpha_{i,j}\geq 0, \forall j=1,\ldots,p \text{ and } i=1,\ldots,n
  \end{eqnarray*}
\end{center}
#+END_EXPORT
*** Bayesian modelling
- Likelihood formulation
  $$f(\mathbf{x}_i|\mathbf{M},\boldsymbol{\alpha}_i,\sigma^2) = \left(\frac{1}{2\pi\sigma^2}\right)^{d/2}\exp\left(-\frac{\|\mathbf{x}_i-\mathbf{M}\boldsymbol{\alpha}_i\|^2}{2\sigma^2}\right)$$
- Conjoint estimation of /endmembers/ and /abundances/ cite:Dobigeon_IEEE_Trans_SP_2009
- Rely in MCMC algorithm
  + Long processing time
  + Provide usually better results than geometric methods in critical situation (no pure pixels...)
- Possible to add spatial dependencies cite:Eches_IEEE_Trans_GRS_2011

#+ATTR_LATEX: :width 0.4\linewidth
[[file:./figures/bayesian.png]]
* References                                                         :export:
*** Bibliography
  :PROPERTIES:
  :BEAMER_OPT: fragile,allowframebreaks,label=
  :END:      
  \printbibliography
*** 
#+BEGIN_CENTER
\tiny Creative Commons Attribution-ShareAlike 4.0 Unported License
\normalsize

#+ATTR_LATEX: :width 0.1\textwidth
[[file:figures/cc-by-sa.png]]
#+END_CENTER
